<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Borrowable Books</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body { background:#f5f7fb; padding:40px; font-family: Arial, sans-serif; }

        .cat-box {
            border-left:6px solid #f1c40f;
            border-radius:10px;
            background:white;
            margin-bottom:25px;
        }

        .cat-header {
            padding:18px 25px;
            font-size:20px;
            font-weight:bold;
            cursor:pointer;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .cat-header:hover { background:#fff6d6; }

        .add-btn {
            background:#f1c40f;
            color:white;
            padding:7px 14px;
            border-radius:6px;
            text-decoration:none;
        }

        .book-row {
            display:flex;
            justify-content:space-between;
            padding:10px 5px;
            border-bottom:1px solid #eee;
        }

        .actions { display:flex; gap:8px; }

        .search-box {
            max-width: 300px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

<!-- HEADER -->
<div class="d-flex justify-content-between mb-4">
    <h2 class="fw-bold" style="color:#f1c40f;">
        <i class="fa-solid fa-book"></i> Borrowable Books
    </h2>

    <div class="d-flex gap-3">
        <a href="/admin/books" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Back to Library Admin Panel
        </a>

        <a href="/admin/borrowable/history" class="btn btn-primary">
            <i class="fa-solid fa-clock-rotate-left"></i> History
        </a>
    </div>
</div>

<!-- SEARCH -->
<div class="search-box">
    <input id="searchInput" type="text" class="form-control" placeholder="Search books..."
           onkeyup="searchBooks()">
</div>

<!-- ========================= CATEGORIES =========================== -->

<div th:each="entry, iter : ${groupedBooks}">

    <div class="cat-box">

        <!-- Header -->
        <div class="cat-header"
             data-bs-toggle="collapse"
             th:data-bs-target="'#cat' + ${iter.index}">
            <span th:text="${entry.key}"></span>
            <i class="fa-solid fa-chevron-down"></i>
        </div>

        <!-- Collapse content -->
        <div class="collapse"
             th:id="'cat' + ${iter.index}">

            <!-- Filters + Add book -->
            <div class="d-flex justify-content-between mt-3 px-4">

                <select class="filter-select"
                        th:onchange="'sortCategory(\'body' + ${iter.index} + '\', this.value)'">
                    <option value="">Sort by...</option>
                    <option value="title">Title A–Z</option>
                    <option value="author">Author A–Z</option>
                    <option value="yearAsc">Year ↑</option>
                    <option value="yearDesc">Year ↓</option>
                    <option value="qtyAsc">Quantity ↑</option>
                    <option value="qtyDesc">Quantity ↓</option>
                </select>

                <a th:href="@{'/admin/borrowable/add?category=' + ${entry.key}}" class="add-btn">
                    <i class="fa-solid fa-plus"></i> Add Book
                </a>
            </div>

            <!-- Books container -->
            <div class="mt-3 px-4 pb-3"
                 th:id="'body' + ${iter.index}">

                <div class="book-row"
                     th:each="b : ${entry.value}"
                     th:data-title="${b.title}"
                     th:data-author="${b.author}"
                     th:data-year="${b.year}"
                     th:data-qty="${b.quantity}">

                    <div>
                        <b th:text="${b.title}"></b>
                        – <span th:text="${b.author}"></span>
                        (<span th:text="${b.year}"></span>)
                        • Qty: <b th:text="${b.quantity}"></b>
                        • Borrowed: <b th:text="${b.borrowed}"></b>
                    </div>

                    <div class="actions">
                        <a th:href="@{'/admin/borrowable/edit/' + ${b.id}}" class="btn btn-warning btn-sm">
                            <i class="fa-solid fa-pen"></i> Edit
                        </a>

                        <a th:href="@{'/admin/borrowable/delete/' + ${b.id}}"
                           onclick="return confirmDelete()"
                           class="btn btn-danger btn-sm">
                            <i class="fa-solid fa-trash"></i> Delete
                        </a>
                    </div>

                </div>

            </div>
        </div>
    </div>

</div>

<!-- ===================== JS FUNCTIONS =========================== -->

<script>

    function confirmDelete() {
        return confirm("Are you sure you want to delete this book?");
    }

    function searchBooks() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.querySelectorAll(".book-row");

        rows.forEach(r => {
            let text = r.innerText.toLowerCase();
            r.style.display = text.includes(input) ? "flex" : "none";
        });
    }

    function sortCategory(id, mode) {

        if (!mode) return;

        let container = document.getElementById(id);
        let rows = Array.from(container.querySelectorAll(".book-row"));

        rows.sort((a, b) => {
            switch (mode) {

                case "title":
                    return a.dataset.title.localeCompare(b.dataset.title);

                case "author":
                    return a.dataset.author.localeCompare(b.dataset.author);

                case "yearAsc":
                    return Number(a.dataset.year) - Number(b.dataset.year);

                case "yearDesc":
                    return Number(b.dataset.year) - Number(a.dataset.year);

                case "qtyAsc":
                    return Number(a.dataset.qty) - Number(b.dataset.qty);

                case "qtyDesc":
                    return Number(b.dataset.qty) - Number(a.dataset.qty);
            }
        });

        rows.forEach(r => container.appendChild(r));
    }

</script>

</body>
</html>
