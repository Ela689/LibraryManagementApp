<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Digital Books</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            background: #eef3f9;
            padding: 40px;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Search + Filter Section */
        .filter-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .category-box {
            background: #fff;
            border-radius: 14px;
            padding: 18px 25px;
            margin-bottom: 20px;
            border-left: 8px solid #0057d8;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .category-title {
            display: flex;
            justify-content: space-between;
            font-size: 22px;
            font-weight: 700;
            color: #0057d8;
        }

        .book-row {
            padding: 12px 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-view {
            background: #6c63ff;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            margin-right: 6px;
            border: none;
        }

        .btn-download {
            background: #1abc9c;
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
        }

        /* HISTORY BOX */
        #historyToggle {
            position: fixed;
            top: 20px;
            right: 25px;
            background: #007bff;
            color: white;
            padding: 10px 18px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            z-index: 999;
        }

        #historyBox {
            position: fixed;
            top: 70px;
            right: 25px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 14px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            display: none;
            z-index: 999;
        }

        #historyList a {
            text-decoration: none;
            font-weight: 500;
            color: #0057d8;
        }

        #historyList a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

<h2 class="text-primary mb-4">
    <i class="fa-solid fa-tablet-screen-button"></i> Digital Books
</h2>

<!-- ============================ -->
<!-- SEARCH + SORT -->
<!-- ============================ -->
<div class="filter-box">
    <div class="row g-3">

        <!-- SEARCH -->
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control"
                   placeholder="Search by title, author, year...">
        </div>

        <!-- CATEGORY FILTER (optional, pentru design la fel) -->
        <div class="col-md-3">
            <select id="categoryFilter" class="form-select">
                <option value="">All categories</option>
                <option th:each="entry : ${groupedBooks}"
                        th:text="${entry.key}"
                        th:value="${entry.key}"></option>
            </select>
        </div>

        <!-- SORT -->
        <div class="col-md-3">
            <select id="sortSelect" class="form-select">
                <option value="title"
                        th:selected="${param.sort} == null or ${param.sort} == 'title'">
                    Sort by title
                </option>
                <option value="author"
                        th:selected="${param.sort} == 'author'">
                    Sort by author
                </option>
                <option value="year"
                        th:selected="${param.sort} == 'year'">
                    Sort by year
                </option>
            </select>
        </div>

    </div>
</div>

<!-- HISTORY BUTTON -->
<div id="historyToggle">
    <i class="fa-solid fa-clock-rotate-left"></i> History
</div>

<!-- FLOATING HISTORY PANEL -->
<div id="historyBox">
    <h5><i class="fa-solid fa-clock-rotate-left"></i> Recent Views</h5>
    <ul id="historyList" class="list-group mb-3"></ul>
    <button class="btn btn-danger btn-sm w-100" onclick="clearHistory()">Clear History</button>
</div>


<!-- ============================ -->
<!-- CATEGORY SECTIONS -->
<!-- ============================ -->
<div class="container">

    <div th:each="entry, iter : ${groupedBooks}">

        <div class="category-box"
             data-bs-toggle="collapse"
             th:data-bs-target="'#cat' + ${iter.index}">
            <div class="category-title">
                <span class="category-name" th:text="${entry.key}"></span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>

        <div class="collapse"
             th:id="'cat' + ${iter.index}">
            <div class="bg-white p-3 rounded">

                <div class="book-row"
                     th:each="b : ${entry.value}"
                     th:id="'digital-' + ${b.id}"
                     th:data-title="${b.title}"
                     th:data-author="${b.author}"
                     th:data-year="${b.year}"
                     th:data-category="${b.category}"
                >

                    <div>
                        <b th:text="${b.title}"></b> –
                        <span th:text="${b.author}"></span>
                        (<span th:text="${b.year}"></span>)
                    </div>

                    <div class="d-flex">

                        <!-- VIEW -->
                        <a th:href="@{'/user/books/digital/view/' + ${b.fileName}}"
                           target="_blank"
                           class="btn-view"
                           th:onclick="|saveHistory(${b.id})|">
                            <i class="fa-solid fa-eye"></i> View
                        </a>

                        <!-- DOWNLOAD -->
                        <a th:href="@{'/user/books/digital/download/' + ${b.fileName}}"
                           class="btn-download ms-2">
                            <i class="fa-solid fa-download"></i> Download
                        </a>
                    </div>

                </div>

            </div>
        </div>

    </div>

    <a href="/user/home" class="btn btn-secondary mt-4">← Back</a>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* =======================================================
       SEARCH + CATEGORY FILTER
    ======================================================= */
    function applyFilters() {
        let text = document.getElementById("searchInput").value.toLowerCase();
        let category = document.getElementById("categoryFilter").value;

        document.querySelectorAll(".book-row").forEach(row => {
            const title = row.dataset.title.toLowerCase();
            const author = row.dataset.author.toLowerCase();
            const year = row.dataset.year;
            const rowCategory = row.dataset.category;

            let match =
                (title.includes(text) ||
                    author.includes(text) ||
                    year.includes(text)) &&
                (category === "" || category === rowCategory);

            row.style.display = match ? "" : "none";
        });
    }

    document.getElementById("searchInput").addEventListener("keyup", applyFilters);
    document.getElementById("categoryFilter").addEventListener("change", applyFilters);


    /* =======================================================
       SORT (server-side)
    ======================================================= */
    document.getElementById("sortSelect").addEventListener("change", function () {
        let sortField = this.value;
        window.location.href = "/user/books/digital?sort=" + sortField;
    });


    /* =======================================================
       HISTORY (localStorage) – similar cu borrowable
    ======================================================= */
    function saveHistory(id) {
        const row = document.getElementById("digital-" + id);
        if (!row) return;

        const title = row.dataset.title;
        const fileName = row.querySelector(".btn-view")
            .getAttribute("href")
            .split("/view/")[1];

        let list = JSON.parse(localStorage.getItem("digitalHistory") || "[]");

        // scoatem duplicatele
        list = list.filter(item => item.id !== id);

        // punem primul
        list.unshift({id, title, fileName});

        // maxim 10 intrări
        if (list.length > 10) list.pop();

        localStorage.setItem("digitalHistory", JSON.stringify(list));
    }

    function loadHistory() {
        let list = JSON.parse(localStorage.getItem("digitalHistory") || "[]");
        let box = document.getElementById("historyList");

        box.innerHTML = "";

        list.forEach(item => {
            let li = document.createElement("li");
            li.classList.add("list-group-item");

            li.innerHTML =
                `<i class="fa-solid fa-file-pdf me-2 text-danger"></i>
                 <a href="/user/books/digital/view/${item.fileName}" target="_blank">${item.title}</a>`;

            box.appendChild(li);
        });
    }

    function clearHistory() {
        localStorage.removeItem("digitalHistory");
        loadHistory();
    }

    document.getElementById("historyToggle").onclick = () => {
        let box = document.getElementById("historyBox");
        box.style.display = box.style.display === "block" ? "none" : "block";
        loadHistory();
    };
</script>

</body>
</html>
