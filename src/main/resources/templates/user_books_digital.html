<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Digital Books</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* ================= BACKGROUND ================= */
        body {
            min-height: 100vh;
            background:
                    linear-gradient(
                            rgba(20,30,50,0.15),
                            rgba(20,30,50,0.15)
                    ),
                    url("https://images.unsplash.com/photo-1507842217343-583bb7270b66");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            padding: 40px;
            font-family: "Segoe UI", system-ui, sans-serif;
        }

        /* ================= HEADER ================= */
        h2 {
            font-weight: 800;
            color: #2563eb;
            text-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        /* ================= FILTER BOX ================= */
        .filter-box {
            background: rgba(255,255,255,0.94);
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(0,0,0,0.25);
            margin-bottom: 30px;
        }

        /* ================= CATEGORY CARD ================= */
        .category-box {
            background: linear-gradient(135deg, #93c5fd, #2563eb);
            border-radius: 20px;
            padding: 18px 25px;
            margin-bottom: 18px;
            cursor: pointer;
            box-shadow: 0 22px 45px rgba(0,0,0,0.35);
            transition: transform 0.15s ease;
        }

        .category-box:hover {
            transform: translateY(-2px);
        }

        .category-title {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 800;
            color: #0f172a;
        }

        /* ================= BOOK LIST ================= */
        .book-row {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-row:last-child {
            border-bottom: none;
        }

        /* ================= BUTTONS ================= */
        .view-btn {
            background: #2563eb;
            color: white;
            padding: 6px 16px;
            border-radius: 999px;
            text-decoration: none;
            font-weight: 600;
        }

        .view-btn:hover {
            background: #1d4ed8;
            color: white;
        }

        .download-btn {
            background: #16a34a;
            color: white;
            padding: 6px 16px;
            border-radius: 999px;
            text-decoration: none;
            font-weight: 600;
        }

        .download-btn:hover {
            background: #15803d;
            color: white;
        }

        /* ================= HISTORY ================= */
        #historyToggle {
            position: fixed;
            top: 20px;
            right: 25px;
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 700;
            z-index: 999;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        #historyBox {
            position: fixed;
            top: 70px;
            right: 25px;
            width: 320px;
            max-height: 420px;
            overflow-y: auto;
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(14px);
            border-radius: 20px;
            padding: 18px;
            box-shadow: 0 22px 50px rgba(0,0,0,0.45);
            display: none;
            z-index: 999;
        }
    </style>
</head>

<body>

<h2 class="mb-4">
    <i class="fa-solid fa-tablet-screen-button"></i> Digital Books
</h2>

<!-- ================= FILTERS ================= -->
<div class="filter-box">
    <div class="row g-3">
        <div class="col-md-6">
            <input id="searchInput" class="form-control"
                   placeholder="Search by title, author or year">
        </div>

        <div class="col-md-3">
            <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                <option th:each="entry : ${groupedBooks}"
                        th:value="${entry.key}"
                        th:text="${entry.key}">
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <select id="sortSelect" class="form-select">
                <option value="title">Sort by title</option>
                <option value="author">Sort by author</option>
                <option value="year">Sort by year</option>
            </select>
        </div>
    </div>
</div>

<!-- ================= HISTORY ================= -->
<div id="historyToggle">
    <i class="fa-solid fa-clock-rotate-left"></i> History
</div>

<div id="historyBox">
    <h5 class="fw-bold mb-3">Recent Views</h5>
    <ul id="historyList" class="list-group mb-3"></ul>
    <button class="btn btn-danger btn-sm w-100" onclick="clearHistory()">Clear History</button>
</div>

<!-- ================= BOOK LIST ================= -->
<div class="container">

    <div th:each="entry, iter : ${groupedBooks}">

        <div class="category-box"
             data-bs-toggle="collapse"
             th:data-bs-target="'#cat' + ${iter.index}">
            <div class="category-title">
                <span th:text="${entry.key}"></span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>

        <div class="collapse" th:id="'cat' + ${iter.index}">
            <div class="bg-white rounded-4 p-3 mb-3">

                <div class="book-row"
                     th:each="b : ${entry.value}"
                     th:id="'digital-' + ${b.id}"
                     th:data-title="${b.title}"
                     th:data-author="${b.author}"
                     th:data-year="${b.year}"
                     th:data-category="${b.category}">

                    <div>
                        <b th:text="${b.title}"></b> –
                        <span th:text="${b.author}"></span>
                        (<span th:text="${b.year}"></span>)
                    </div>

                    <div class="d-flex gap-2">
                        <a th:href="@{'/user/books/digital/view/' + ${b.fileName}}"
                           target="_blank"
                           class="view-btn"
                           th:onclick="|saveHistory(${b.id})|">
                            View
                        </a>

                        <a th:href="@{'/user/books/digital/download/' + ${b.fileName}}"
                           class="download-btn">
                            Download
                        </a>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <a href="/user/home" class="btn btn-secondary mt-4">← Back</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ================= JS – NEMODIFICAT ================= -->
<script>
    function applyFilters() {
        let text = document.getElementById("searchInput").value.toLowerCase();
        let category = document.getElementById("categoryFilter").value;

        document.querySelectorAll(".book-row").forEach(row => {
            let match =
                (row.dataset.title.toLowerCase().includes(text) ||
                    row.dataset.author.toLowerCase().includes(text) ||
                    row.dataset.year.includes(text)) &&
                (category === "" || row.dataset.category === category);

            row.style.display = match ? "" : "none";
        });
    }

    document.getElementById("searchInput").addEventListener("keyup", applyFilters);
    document.getElementById("categoryFilter").addEventListener("change", applyFilters);
    document.getElementById("sortSelect").addEventListener("change",
        e => location.href = "/user/books/digital?sort=" + e.target.value);

    function saveHistory(id) {
        const row = document.getElementById("digital-" + id);
        let file = row.querySelector(".view-btn").href.split("/view/")[1];
        let title = row.dataset.title;

        let list = JSON.parse(localStorage.getItem("digitalHistory") || "[]");
        list = list.filter(x => x.id !== id);
        list.unshift({id, title, file});
        if (list.length > 10) list.pop();

        localStorage.setItem("digitalHistory", JSON.stringify(list));
    }

    function clearHistory() {
        localStorage.removeItem("digitalHistory");
        document.getElementById("historyList").innerHTML = "";
    }

    document.getElementById("historyToggle").onclick = () => {
        let box = document.getElementById("historyBox");
        box.style.display = box.style.display === "block" ? "none" : "block";

        let list = JSON.parse(localStorage.getItem("digitalHistory") || "[]");
        let ul = document.getElementById("historyList");
        ul.innerHTML = "";

        list.forEach(b => {
            ul.innerHTML += `<li class="list-group-item">
                <a href="/user/books/digital/view/${b.file}" target="_blank">${b.title}</a>
            </li>`;
        });
    };
</script>

</body>
</html>
