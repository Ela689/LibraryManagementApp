<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Borrowable Books</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            min-height: 100vh;
            background:
                    linear-gradient(rgba(15,15,15,0.55), rgba(15,15,15,0.55)),
                    url("https://images.unsplash.com/photo-1507842217343-583bb7270b66");
            background-size: cover;
            background-attachment: fixed;
            padding: 40px;
            font-family: "Segoe UI", system-ui, sans-serif;
        }

        h2 {
            font-weight: 800;
            color: #f59e0b;
        }

        .filter-box {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            margin-bottom: 20px;
        }

        .category-box {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            border-radius: 20px;
            padding: 18px 25px;
            margin-bottom: 18px;
            cursor: pointer;
            box-shadow: 0 20px 45px rgba(0,0,0,0.35);
        }

        .category-title {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 800;
            color: #1f2937;
        }

        .book-row {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .borrow-btn {
            background: #16a34a;
            color: white;
            padding: 6px 14px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
        }

        .borrow-btn.disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .details-btn {
            background: #f59e0b;
            color: #1f2937;
            padding: 6px 14px;
            border-radius: 999px;
            text-decoration: none;
            font-weight: 600;
        }

        .borrowed-badge {
            background: #ec4899;
            color: white;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }

        #historyToggle {
            position: fixed;
            top: 20px;
            right: 25px;
            background: #f59e0b;
            color: #1f2937;
            padding: 10px 18px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 700;
            z-index: 999;
        }

        #historyBox {
            position: fixed;
            top: 70px;
            right: 25px;
            width: 320px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(14px);
            border-radius: 20px;
            padding: 18px;
            display: none;
            z-index: 999;
        }
    </style>
</head>

<body>

<h2><i class="fa-solid fa-book-bookmark"></i> Borrowable Books</h2>

<div class="filter-box">
    <div class="row g-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control"
                   placeholder="Search by title or author">
        </div>
        <div class="col-md-6 text-end">
            <a href="/user/borrowable/my-borrows" class="btn btn-warning fw-bold">
                <i class="fa-solid fa-clock-rotate-left"></i> History
            </a>
        </div>
    </div>
</div>

<div class="container">

    <div th:each="entry, iter : ${groupedBooks}">

        <div class="category-box"
             data-bs-toggle="collapse"
             th:data-bs-target="'#cat' + ${iter.index}">
            <div class="category-title">
                <span th:text="${entry.key}"></span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>

        <div class="collapse" th:id="'cat' + ${iter.index}">
            <div class="bg-white rounded-4 p-3 mb-3">

                <div class="book-row"
                     th:each="b : ${entry.value}"
                     th:data-title="${b.title}"
                     th:data-author="${b.author}">

                    <div>
                        <b th:text="${b.title}"></b> –
                        <span th:text="${b.author}"></span>
                        (<span th:text="${b.year}"></span>)
                    </div>

                    <div class="d-flex align-items-center gap-2">

                        <!-- BADGE BORROWED -->
                        <span th:if="${borrowedBookIds != null and borrowedBookIds.contains(b.id)}"
                              class="borrowed-badge">
                            Borrowed by you
                        </span>

                        <!-- BORROW -->
                        <form th:if="${borrowedBookIds == null or !borrowedBookIds.contains(b.id)}"
                              th:action="@{'/user/borrowable/borrow/' + ${b.id}}"
                              method="post"
                              onsubmit="return confirmBorrow();">
                            <button class="borrow-btn">Borrow</button>
                        </form>

                        <button th:if="${borrowedBookIds != null and borrowedBookIds.contains(b.id)}"
                                type="button"
                                class="borrow-btn disabled"
                                onclick="alreadyBorrowedAlert()">
                            Borrow
                        </button>

                        <!-- DETAILS -->
                        <a th:href="@{'/user/borrowable/details/' + ${b.id}}"
                           class="details-btn">
                            Details
                        </a>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <a href="/user/home" class="btn btn-secondary mt-4">← Back</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function confirmBorrow() {
        return confirm("Are you sure you want to borrow this book?\nYou will not be able to unborrow it.");
    }

    function alreadyBorrowedAlert() {
        alert("You already borrowed this book.\nYou cannot borrow it again until you return it.");
    }

    document.getElementById("searchInput").addEventListener("keyup", function () {
        const val = this.value.toLowerCase();
        document.querySelectorAll(".book-row").forEach(row => {
            row.style.display =
                row.dataset.title.toLowerCase().includes(val) ||
                row.dataset.author.toLowerCase().includes(val)
                    ? ""
                    : "none";
        });
    });
</script>

</body>
</html>
